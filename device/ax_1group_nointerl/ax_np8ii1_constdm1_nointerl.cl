#define LX1 8 
#define LY1 8 
#define LZ1 8 

__constant double shdxm1[LX1*LY1] = {-13.999999999999996,-3.2099157030029883,0.79247668132051452,-0.37215043572859474,0.24333071272379098,-0.20328456890059265,0.21995751477130429,-0.50000000000000011,18.937598607117366,-3.6775311776888145E-015,-2.8064757947364334,1.0789446887904524,-0.66115735090031114,0.53703958615766079,-0.57356541494026425,1.2976873883202320,-7.5692898193484917,4.5435850645665656,-4.1850457928283788E-016,-2.3781872335155056,1.1353580168811115,-0.84502255650651037,0.86944809833149328,-1.9416594255441235,4.2979081642651762,-2.1120612143145427,2.8755174059725039,-6.4264997920496587E-016,-2.3889243591582385,1.3727858318060284,-1.2942320509135019,2.8101889892579495,-2.8101889892579499,1.2942320509135017,-1.3727858318060282,2.3889243591582381,1.8253300928627324E-015,-2.8755174059725044,2.1120612143145423,-4.2979081642651744,1.9416594255441229,-0.86944809833149317,0.84502255650651059,-1.1353580168811115,2.3781872335155043,5.4382734164421932E-016,-4.5435850645665647,7.5692898193484872,-1.2976873883202318,0.57356541494026403,-0.53703958615766090,0.66115735090031102,-1.0789446887904519,2.8064757947364325,3.4624179327334132E-015,-18.937598607117359,0.49999999999999983,-0.21995751477130432,0.20328456890059265,-0.24333071272379089,0.37215043572859452,-0.79247668132051408,3.2099157030029875,13.999999999999991};

__constant double shdxtm1[LX1*LY1] ={-13.999999999999996,18.937598607117366,-7.5692898193484917,4.2979081642651762,-2.8101889892579499,1.9416594255441229,-1.2976873883202318,0.49999999999999983,-3.2099157030029883,-3.6775311776888145E-015,4.5435850645665656,-2.1120612143145427,1.2942320509135017,-0.86944809833149317,0.57356541494026403,-0.21995751477130432,0.79247668132051452,-2.8064757947364334,-4.1850457928283788E-016,2.8755174059725039,-1.3727858318060282,0.84502255650651059,-0.53703958615766090,0.20328456890059265,-0.37215043572859474,1.0789446887904524,-2.3781872335155056,-6.4264997920496587E-016,2.3889243591582381,-1.1353580168811115,0.66115735090031102,-0.24333071272379089,0.24333071272379098,-0.66115735090031114,1.1353580168811115,-2.3889243591582385,1.8253300928627324E-015,2.3781872335155043,-1.0789446887904519,0.37215043572859452,-0.20328456890059265,0.53703958615766079,-0.84502255650651037,1.3727858318060284,-2.8755174059725044,5.4382734164421932E-016,2.8064757947364325,-0.79247668132051408,0.21995751477130429,-0.57356541494026425,0.86944809833149328,-1.2942320509135019,2.1120612143145423,-4.5435850645665647,3.4624179327334132E-015,3.2099157030029875,-0.50000000000000011,1.2976873883202320,-1.9416594255441235,2.8101889892579495,-4.2979081642651744,7.5692898193484872,-18.937598607117359,13.999999999999991};


__attribute__((scheduler_target_fmax_mhz(300)))
__kernel void ax(__global double * restrict w,
                        __global const double * restrict p,
                        __global const double * restrict g1,
                        __global const double * restrict g2,
                        __global const double * restrict g3,
                        __global const double * restrict g4,
                        __global const double * restrict g5,
                        __global const double * restrict g6,
                        __global const double * restrict dxm1,
                        __global const double * restrict dxtm1,
                        int N){

    for(unsigned ele = 0; ele < N; ele += LX1*LY1*LZ1){
        double shur[LX1*LY1*LZ1];
        double shus[LX1*LY1*LZ1];
        double shut[LX1*LY1*LZ1];
        double shw[LX1*LY1*LZ1];
        double shg1[LX1*LY1*LZ1];
        double shg2[LX1*LY1*LZ1];
        double shg3[LX1*LY1*LZ1];
        double shg4[LX1*LY1*LZ1];
        double shg5[LX1*LY1*LZ1];
        double shg6[LX1*LY1*LZ1];
        double shu[LX1*LY1*LZ1];

        #pragma unroll 32
        for(unsigned ijk=0; ijk<LX1*LY1*LZ1; ++ijk){
            shu[ijk] = p[ijk + ele];
            shg1[ijk] = g1[ijk + ele];
            shg2[ijk] = g2[ijk + ele];
            shg3[ijk] = g3[ijk + ele];
            shg4[ijk] = g4[ijk + ele];
            shg5[ijk] = g5[ijk + ele];
            shg6[ijk] = g6[ijk + ele];
        }
        #pragma loop_coalesce
        #pragma ii 1
        for (unsigned k=0; k<LZ1; ++k){
            for(unsigned j = 0; j < LY1; j++){
                #pragma unroll
                for(unsigned i = 0; i < LX1; i++){
                    int ij = i + j*LX1;
                    int ijk = ij + k*LX1*LY1;
                    double G00 = shg1[ijk];
                    double G01 = shg2[ijk];
                    double G02 = shg3[ijk];
                    double G11 = shg4[ijk];
                    double G12 = shg5[ijk];
                    double G22 = shg6[ijk];
                    double rtmp = 0.0;
                    double stmp = 0.0;
                    double ttmp = 0.0;
                    #pragma unroll 
                    for (unsigned l = 0; l<LX1; l++){
                      rtmp += shdxtm1[l+i*LX1] * shu[l+j*LX1 +k*LX1*LY1];
                      stmp += shdxtm1[l+j*LX1] * shu[i+l*LX1 + k*LX1*LY1];
                      ttmp += shdxtm1[l+k*LX1] * shu[ij + l*LX1*LY1];
                    }
                    shur[ijk] = G00*rtmp
                             + G01*stmp
                             + G02*ttmp;
                    shus[ijk] = G01*rtmp
                             + G11*stmp
                             + G12*ttmp;
                    shut[ijk]  = G02*rtmp
                             + G12*stmp
                             + G22*ttmp;
                }
            }
        }
        #pragma loop_coalesce 
        #pragma ii 1
        for (unsigned k=0; k<LZ1; ++k){
            for(unsigned j = 0; j < LY1; j++){
                #pragma unroll
                for(unsigned i = 0; i < LX1; i++){
                    int ij = i + j*LX1;
                    int ijk = ij + k*LX1*LY1;
                    
                    double wijke = 0.0;
                    #pragma unroll 
                    for(unsigned l = 0; l<LX1; l++){
                        wijke += shdxm1[l + i*LX1] * shur[l+j*LX1+k*LX1*LY1];
                        wijke += shdxm1[l + j*LX1] * shus[i+l*LX1+k*LX1*LY1];
                        wijke += shdxm1[l + k*LX1] * shut[i+j*LX1+l*LX1*LY1];
                    }
                    shw[ijk] = wijke;
                }
            }
        }

        #pragma unroll 32 
        for(unsigned ijk=0; ijk<LX1*LY1*LZ1; ++ijk)
            w[ijk + ele] = shw[ijk];
    }
}

